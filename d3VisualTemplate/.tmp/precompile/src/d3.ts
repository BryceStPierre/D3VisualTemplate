module powerbi.extensibility.utils {

	export module D3 {

		export const deps = "var d3_sankey=function(o){var r={},c=24,i=8,f=[1,1],a=[],s=[];function t(){function r(n,r){return n.source.y-r.source.y}function t(n,r){return n.target.y-r.target.y}a.forEach(function(n){n.sourceLinks.sort(t),n.targetLinks.sort(r)}),a.forEach(function(n){var r=0,t=0;n.sourceLinks.forEach(function(n){n.sy=r,r+=n.dy}),n.targetLinks.forEach(function(n){n.ty=t,t+=n.dy})})}function y(n){return n.y+n.dy/2}function h(n){return n.value}return r.nodeWidth=function(n){return arguments.length?(c=+n,r):c},r.nodePadding=function(n){return arguments.length?(i=+n,r):i},r.nodes=function(n){return arguments.length?(a=n,r):a},r.links=function(n){return arguments.length?(s=n,r):s},r.size=function(n){return arguments.length?(f=n,r):f},r.layout=function(n){return a.forEach(function(n){n.sourceLinks=[],n.targetLinks=[]}),s.forEach(function(n){var r=n.source,t=n.target;\"number\"==typeof r&&(r=n.source=a[n.source]),\"number\"==typeof t&&(t=n.target=a[n.target]),r.sourceLinks.push(n),t.targetLinks.push(n)}),a.forEach(function(n){n.value=Math.max(d3.sum(n.sourceLinks,h),d3.sum(n.targetLinks,h))}),function(){var r,n=a,t=0;for(;n.length;)r=[],n.forEach(function(n){n.x=t,n.dx=c,n.sourceLinks.forEach(function(n){r.push(n.target)})}),n=r,++t;e=t,a.forEach(function(n){n.sourceLinks.length||(n.x=e-1)}),u=(o-c)/(t-1),a.forEach(function(n){n.x*=u});var u;var e}(),function(n){var r=d3.nest().key(function(n){return n.x}).sortKeys(d3.ascending).entries(a).map(function(n){return n.values});t=d3.min(r,function(n){return(f[1]-(n.length-1)*i)/d3.sum(n,h)}),r.forEach(function(n){n.forEach(function(n,r){n.y=r,n.dy=n.value*t})}),s.forEach(function(n){n.dy=n.value*t}),c();var t;for(var u=1;0<n;--n)o(u*=.99),c(),e(u),c();function e(t){function u(n){return y(n.source)*n.value}r.forEach(function(n,r){n.forEach(function(n){if(n.targetLinks.length){var r=d3.sum(n.targetLinks,u)/d3.sum(n.targetLinks,h);n.y+=(r-y(n))*t}})})}function o(t){function u(n){return y(n.target)*n.value}r.slice().reverse().forEach(function(n){n.forEach(function(n){if(n.sourceLinks.length){var r=d3.sum(n.sourceLinks,u)/d3.sum(n.sourceLinks,h);n.y+=(r-y(n))*t}})})}function c(){function c(n,r){return n.y-r.y}r.forEach(function(n){var r,t,u,e=0,o=n.length;for(n.sort(c),u=0;u<o;++u)r=n[u],0<(t=e-r.y)&&(r.y+=t),e=r.y+r.dy+i;if(0<(t=e-i-f[1]))for(e=r.y-=t,u=o-2;0<=u;--u)r=n[u],0<(t=r.y+r.dy+i-e)&&(r.y-=t),e=r.y})}}(n),t(),r},r.relayout=function(){return t(),r},r.link=function(){var f=.5;function r(n){var r=n.source.x+n.source.dx,t=n.target.x,u=d3.interpolateNumber(r,t),e=u(f),o=u(1-f),c=n.source.y+n.sy+n.dy/2,i=n.target.y+n.ty+n.dy/2;return\"M\"+r+\",\"+c+\"C\"+e+\",\"+c+\" \"+o+\",\"+i+\" \"+t+\",\"+i}return r.curvature=function(n){return arguments.length?(f=+n,r):f},r},r};";
		export const script = "var width=pbi.width,height=pbi.height,margin={top:10,right:10,bottom:10,left:10},vis=d3.select(\"#chart\").attr(\"width\",width).attr(\"height\",height).append(\"g\").attr(\"class\",\"vis\").attr(\"width\",width).attr(\"height\",height);width=width-margin.left-margin.right,height=height-margin.top-margin.bottom;var units=\"Units\",formatNumber=d3.format(\",.0f\"),format=function(t){return formatNumber(t)+\" \"+units},color=d3.scale.category20(),svg=vis.append(\"g\").attr(\"transform\",\"translate(\"+margin.left+\",\"+margin.top+\")\"),graph={nodes:[],links:[]},uniqueNodes=[],accessor=function(t){var e,n=[];for(e in t)n.push(e);return{source:t[n[0]],target:t[n[1]],amount:+t[n[2]]}};pbi.dsv(accessor,function(t){t.forEach(function(t){var e=t.amount;0!==e&&(graph.nodes.push({name:t.source}),graph.nodes.push({name:t.target}),graph.links.push({source:t.source,target:t.target,value:e}),-1===uniqueNodes.indexOf(t.source)&&uniqueNodes.push(t.source),-1===uniqueNodes.indexOf(t.target)&&uniqueNodes.push(t.target))})});var paddingSize=10;paddingSize=8<=uniqueNodes.length?10:6<=uniqueNodes.length?30:4<=uniqueNodes.length?50:70;var sankey=d3_sankey(width).nodeWidth(20).nodePadding(paddingSize).size([width,height]),path=sankey.link();graph.nodes=d3.keys(d3.nest().key(function(t){return t.name}).map(graph.nodes)),graph.links.forEach(function(t,e){graph.links[e].source=graph.nodes.indexOf(graph.links[e].source),graph.links[e].target=graph.nodes.indexOf(graph.links[e].target)}),graph.nodes.forEach(function(t,e){graph.nodes[e]={name:t}}),sankey.nodes(graph.nodes).links(graph.links).layout(32);var link=svg.append(\"g\").selectAll(\".link\").data(graph.links).enter().append(\"path\").attr(\"class\",\"statcan_vis_ext_sankeychart_link\").attr(\"d\",path).style(\"stroke-width\",function(t){return Math.max(1,t.dy)}).sort(function(t,e){return e.dy-t.dy});link.append(\"title\").text(function(t){return t.source.name+\" -> \"+t.target.name+\":\\n\"+format(t.value)});var node=svg.append(\"g\").selectAll(\".node\").data(graph.nodes).enter().append(\"g\").attr(\"class\",\"statcan_vis_ext_sankeychart_node\").attr(\"transform\",function(t){return\"translate(\"+t.x+\",\"+t.y+\")\"}).call(d3.behavior.drag().origin(function(t){return t}).on(\"dragstart\",function(){this.parentNode.appendChild(this)}).on(\"drag\",dragmove));function dragmove(t){d3.select(this).attr(\"transform\",\"translate(\"+t.x+\",\"+(t.y=Math.max(0,Math.min(height-t.dy,d3.event.y)))+\")\"),sankey.relayout(),link.attr(\"d\",path)}node.append(\"rect\").attr(\"height\",function(t){return t.dy}).attr(\"width\",sankey.nodeWidth()).style(\"fill\",function(t){return t.color=color(t.name.replace(/ .*/,\"\"))}).style(\"stroke\",function(t){return d3.rgb(t.color).darker(2)}).append(\"title\").text(function(t){return t.name+\": \\n\"+format(t.value)}),node.append(\"text\").attr(\"font-family\",\"sans-serif\").attr(\"font-size\",\"12px\").attr(\"x\",-6).attr(\"y\",function(t){return t.dy/2}).attr(\"dy\",\".35em\").attr(\"text-anchor\",\"end\").attr(\"transform\",null).text(function(t){return t.name}).filter(function(t){return t.x<width/2}).attr(\"x\",6+sankey.nodeWidth()).attr(\"text-anchor\",\"start\");";
		export const style = ".statcan_vis_ext_sankeychart_node rect{cursor:move;fill-opacity:.9;shape-rendering:crispEdges}.statcan_vis_ext_sankeychart_node text{pointer-events:none;text-shadow:0 1px 0 #fff}.statcan_vis_ext_sankeychart_link{fill:none;stroke:#000;stroke-opacity:.2}.statcan_vis_ext_sankeychart_link:hover{stroke-opacity:.5}.statcan_vis_ext_sankeychart_title{font-family:sans-serif;font-size:12pt}";
	}
}
